# åå°ç®¡ç†ç³»ç»Ÿ - åŠ¨æ€è·¯ç”±å®ç°æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [åç«¯è®¾è®¡](#åç«¯è®¾è®¡)
4. [å‰ç«¯è®¾è®¡](#å‰ç«¯è®¾è®¡)
5. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„

### 1.1 æ ¸å¿ƒæµç¨‹å›¾
```
ç”¨æˆ·ç™»å½•
  â†“
è·å– Token
  â†“
è°ƒç”¨èœå• API (/api/v1/menu/tree)
  â†“
è¿”å›ç”¨æˆ·å¯è®¿é—®çš„èœå•æ ‘
  â†“
å‰ç«¯è½¬æ¢ä¸º Vue Router é…ç½®
  â†“
åŠ¨æ€æ·»åŠ è·¯ç”± (router.addRoute)
  â†“
æ¸²æŸ“ä¾§è¾¹æ èœå•
  â†“
ç”¨æˆ·ç‚¹å‡»èœå• â†’ åŠ è½½å¯¹åº”ç»„ä»¶
```

### 1.2 æƒé™éªŒè¯æµç¨‹
```
å‰ç«¯è¯·æ±‚
  â†“
è·¯ç”±å®ˆå« (beforeEach)
  â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦æƒé™
  â†“
éªŒè¯ç”¨æˆ·æƒé™ (v-permission æŒ‡ä»¤)
  â†“
åç«¯ API æ‹¦æˆªå™¨éªŒè¯
  â†“
è¿”å›æ•°æ®
```

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 æ ¸å¿ƒè¡¨ç»“æ„

#### auth_permission (æƒé™/èœå•è¡¨)
```sql
ä¸»è¦å­—æ®µï¼š
- id, parent_id (æ ‘å½¢ç»“æ„)
- perm_code (æƒé™ç¼–ç : menu:system:user)
- perm_name (æƒé™åç§°: ç”¨æˆ·ç®¡ç†)
- perm_type (ç±»å‹: MENU/BUTTON/API)
- resource_path (èµ„æºè·¯å¾„: /system/user)
- component (å‰ç«¯ç»„ä»¶: system/user/index)
- route_name (è·¯ç”±åç§°: SystemUser)
- icon (å›¾æ ‡)
- hidden (æ˜¯å¦éšè—)
- meta_json (å…ƒä¿¡æ¯: {title, icon, affix})
```

#### auth_role_permission (è§’è‰²-æƒé™å…³è”è¡¨)
```sql
- role_id (è§’è‰²ID)
- permission_id (æƒé™ID)
```

### 2.2 æ•°æ®ç¤ºä¾‹
```json
{
  "id": 1000,
  "parent_id": 0,
  "perm_code": "menu:system",
  "perm_name": "ç³»ç»Ÿç®¡ç†",
  "perm_type": "MENU",
  "resource_path": "/system",
  "component": "Layout",
  "route_name": "System",
  "icon": "Setting",
  "meta_json": {"title": "ç³»ç»Ÿç®¡ç†", "icon": "Setting"}
}
```

---

## ä¸‰ã€åç«¯è®¾è®¡

### 3.1 API æ¥å£åˆ—è¡¨

#### 1. è·å–ç”¨æˆ·èœå•æ ‘
```
GET /api/v1/menu/tree

å“åº”:
{
  "code": 200,
  "data": [
    {
      "id": 1000,
      "name": "ç³»ç»Ÿç®¡ç†",
      "path": "/system",
      "component": "Layout",
      "meta": {"title": "ç³»ç»Ÿç®¡ç†", "icon": "Setting"},
      "children": [...]
    }
  ]
}
```

#### 2. è·å–ç”¨æˆ·è·¯ç”±é…ç½®
```
GET /api/v1/menu/routes

å“åº”: è¿”å›æ ¼å¼åŒ–çš„è·¯ç”±é…ç½®,å¯ç›´æ¥ç”¨äºå‰ç«¯
```

#### 3. è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
```
GET /api/v1/menu/permissions

å“åº”:
{
  "code": 200,
  "data": ["system:user:add", "system:user:edit", ...]
}
```

#### 4. èœå•ç®¡ç† CRUD
```
GET    /api/v1/menu           # æŸ¥è¯¢èœå•åˆ—è¡¨
GET    /api/v1/menu/{id}      # æŸ¥è¯¢èœå•è¯¦æƒ…
POST   /api/v1/menu           # åˆ›å»ºèœå•
PUT    /api/v1/menu/{id}      # æ›´æ–°èœå•
DELETE /api/v1/menu/{id}      # åˆ é™¤èœå•
```

### 3.2 DTO è®¾è®¡

#### MenuTreeVO (èœå•æ ‘è§†å›¾å¯¹è±¡)
```java
public class MenuTreeVO {
    private Long id;
    private String name;          // perm_name
    private String path;          // resource_path
    private String component;
    private String redirect;
    private MenuMetaVO meta;
    private List<MenuTreeVO> children;
}
```

#### MenuMetaVO (èœå•å…ƒä¿¡æ¯)
```java
public class MenuMetaVO {
    private String title;
    private String icon;
    private Boolean hidden;
    private Boolean noCache;
    private Boolean affix;
}
```

---

## å››ã€å‰ç«¯è®¾è®¡

### 4.1 ç›®å½•ç»“æ„
```
src/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ menu.ts              # èœå• API å°è£…
â”œâ”€â”€ router/
â”‚   â”œâ”€â”€ index.ts             # è·¯ç”±ä¸»æ–‡ä»¶
â”‚   â”œâ”€â”€ routes.ts            # é™æ€è·¯ç”±é…ç½®
â”‚   â””â”€â”€ permission.ts        # è·¯ç”±æƒé™å®ˆå«
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ user.ts          # ç”¨æˆ·çŠ¶æ€
â”‚   â”‚   â””â”€â”€ permission.ts    # æƒé™/èœå•çŠ¶æ€
â”œâ”€â”€ layout/
â”‚   â”œâ”€â”€ index.vue            # ä¸»å¸ƒå±€
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Sidebar.vue      # ä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ Navbar.vue       # å¯¼èˆªæ 
â”‚   â”‚   â””â”€â”€ AppMain.vue      # å†…å®¹åŒºåŸŸ
â”œâ”€â”€ directives/
â”‚   â””â”€â”€ permission.ts        # æƒé™æŒ‡ä»¤ v-permission
â””â”€â”€ utils/
    â””â”€â”€ permission.ts        # æƒé™å·¥å…·å‡½æ•°
```

### 4.2 æ ¸å¿ƒå®ç°é€»è¾‘

#### Step 1: API å°è£… (api/menu.ts)
```typescript
export const menuApi = {
  // è·å–èœå•æ ‘
  getMenuTree: () => request.get('/api/v1/menu/tree'),

  // è·å–è·¯ç”±é…ç½®
  getRoutes: () => request.get('/api/v1/menu/routes'),

  // è·å–æƒé™åˆ—è¡¨
  getPermissions: () => request.get('/api/v1/menu/permissions')
}
```

#### Step 2: æƒé™ Store (store/modules/permission.ts)
```typescript
export const usePermissionStore = defineStore('permission', () => {
  const routes = ref<RouteRecordRaw[]>([])
  const permissions = ref<string[]>([])

  // ç”Ÿæˆè·¯ç”±
  async function generateRoutes() {
    const { data } = await menuApi.getRoutes()
    routes.value = formatRoutes(data)
    return routes.value
  }

  // åŠ è½½æƒé™
  async function loadPermissions() {
    const { data } = await menuApi.getPermissions()
    permissions.value = data
  }

  return { routes, permissions, generateRoutes, loadPermissions }
})
```

#### Step 3: è·¯ç”±å®ˆå« (router/permission.ts)
```typescript
router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore()
  const permissionStore = usePermissionStore()

  if (userStore.token) {
    if (!permissionStore.routes.length) {
      // åŠ¨æ€åŠ è½½è·¯ç”±
      const accessRoutes = await permissionStore.generateRoutes()
      accessRoutes.forEach(route => {
        router.addRoute(route)
      })
      next({ ...to, replace: true })
    } else {
      next()
    }
  } else {
    next('/login')
  }
})
```

#### Step 4: æƒé™æŒ‡ä»¤ (directives/permission.ts)
```typescript
export const permission = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding
    const permissionStore = usePermissionStore()

    if (!permissionStore.permissions.includes(value)) {
      el.remove()
    }
  }
}
```

---

## äº”ã€å®ç°æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåç«¯å¼€å‘ âœ…
1. âœ… æ•°æ®åº“è¡¨è®¾è®¡å’Œæ•°æ®åˆå§‹åŒ–
2. â³ åˆ›å»º Entity/DTO/VO
3. â³ å®ç° MenuService ä¸šåŠ¡é€»è¾‘
4. â³ å®ç° MenuController API
5. â³ ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µäºŒï¼šå‰ç«¯åŸºç¡€æ­å»º ğŸ“š
1. åˆ›å»ºé¡¹ç›®ç»“æ„
2. é…ç½® Vue Router
3. æ­å»º Layout å¸ƒå±€
4. å°è£… API è¯·æ±‚

### é˜¶æ®µä¸‰ï¼šåŠ¨æ€è·¯ç”±å®ç° ğŸ¯
1. å®ç°æƒé™ Store
2. å®ç°è·¯ç”±å®ˆå«
3. åŠ¨æ€æ·»åŠ è·¯ç”±
4. èœå•ç»„ä»¶å¼€å‘

### é˜¶æ®µå››ï¼šæƒé™æ§åˆ¶ ğŸ”’
1. å®ç° v-permission æŒ‡ä»¤
2. æŒ‰é’®çº§æƒé™æ§åˆ¶
3. é¡µé¢çº§æƒé™éªŒè¯

### é˜¶æ®µäº”ï¼šè”è°ƒæµ‹è¯• âœ¨
1. å‰åç«¯è”è°ƒ
2. å¤šè§’è‰²æµ‹è¯•
3. è¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## å…­ã€å‰ç«¯å­¦ä¹ è¦ç‚¹ ğŸ“š

### 6.1 Vue 3 æ ¸å¿ƒæ¦‚å¿µ
- **Composition API**: setupã€refã€reactive
- **å“åº”å¼ç³»ç»Ÿ**: æ•°æ®å¦‚ä½•å˜åŒ–è§¦å‘æ›´æ–°
- **ç”Ÿå‘½å‘¨æœŸ**: onMountedã€onBeforeMount

### 6.2 Vue Router åŠ¨æ€è·¯ç”±
- **addRoute()**: åŠ¨æ€æ·»åŠ è·¯ç”±çš„æ ¸å¿ƒ API
- **beforeEach**: å…¨å±€è·¯ç”±å®ˆå«
- **meta**: è·¯ç”±å…ƒä¿¡æ¯

### 6.3 Pinia çŠ¶æ€ç®¡ç†
- **defineStore**: å®šä¹‰çŠ¶æ€ä»“åº“
- **state**: å…±äº«çŠ¶æ€
- **actions**: ä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•

### 6.4 TypeScript åŸºç¡€
- **interface**: å®šä¹‰æ•°æ®ç»“æ„
- **ç±»å‹æ¨å¯¼**: è®© IDE æ™ºèƒ½æç¤º
- **æ³›å‹**: <T> ç±»å‹å‚æ•°

---

## ä¸ƒã€å…³é”®ä»£ç ç‰‡æ®µ

### åç«¯: æ„å»ºèœå•æ ‘
```java
public List<MenuTreeVO> buildMenuTree(List<Permission> permissions) {
    Map<Long, MenuTreeVO> map = new HashMap<>();
    List<MenuTreeVO> roots = new ArrayList<>();

    // è½¬æ¢ä¸º VO
    permissions.forEach(perm -> {
        MenuTreeVO vo = convertToVO(perm);
        map.put(perm.getId(), vo);
    });

    // æ„å»ºæ ‘å½¢ç»“æ„
    map.values().forEach(vo -> {
        if (vo.getParentId() == 0) {
            roots.add(vo);
        } else {
            MenuTreeVO parent = map.get(vo.getParentId());
            if (parent != null) {
                parent.getChildren().add(vo);
            }
        }
    });

    return roots;
}
```

### å‰ç«¯: æ ¼å¼åŒ–è·¯ç”±
```typescript
function formatRoutes(menuData: any[]): RouteRecordRaw[] {
  return menuData.map(menu => ({
    path: menu.path,
    name: menu.name,
    component: loadComponent(menu.component),
    meta: menu.meta,
    children: menu.children ? formatRoutes(menu.children) : []
  }))
}
```

---

## å…«ã€æµ‹è¯•åœºæ™¯

### 8.1 è§’è‰²æƒé™æµ‹è¯•
- è¶…çº§ç®¡ç†å‘˜: èƒ½çœ‹åˆ°æ‰€æœ‰èœå•
- æ™®é€šç®¡ç†å‘˜: åªèƒ½çœ‹åˆ°ç³»ç»Ÿç®¡ç†
- æ™®é€šç”¨æˆ·: åªèƒ½çœ‹åˆ°ä¸ªäººä¸­å¿ƒ

### 8.2 æŒ‰é’®æƒé™æµ‹è¯•
- ç”¨æˆ·ç®¡ç†é¡µé¢: ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒæŒ‰é’®
- åˆ é™¤æŒ‰é’®: åªæœ‰ç®¡ç†å‘˜å¯è§

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£
- [åç«¯å¼€å‘è§„èŒƒ](../specifications/04-åç«¯å¼€å‘è§„èŒƒ.md)
- [å‰ç«¯å¼€å‘è§„èŒƒ](../specifications/03-å‰ç«¯å¼€å‘è§„èŒƒ.md)
- [API æ¥å£è§„èŒƒ](../specifications/02-APIæ¥å£è§„èŒƒ.md)

### å‚è€ƒèµ„æ–™
- [Vue Router å®˜æ–¹æ–‡æ¡£](https://router.vuejs.org/zh/)
- [Pinia å®˜æ–¹æ–‡æ¡£](https://pinia.vuejs.org/zh/)
- [Element Plus æ–‡æ¡£](https://element-plus.org/zh-CN/)

---

> **ç‰ˆæœ¬**: v1.0.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-06
> **ç»´æŠ¤è€…**: AI Assistant
